---
title: "Survivor - Sentiment Multilevel Modeling"
author: "Helen Schmidt"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: false
---
<style>
h1, h2, h3, h4, h5, h6, legend {
    color: #046C9A;
}
</style>

***

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidytext)
library(dplyr)
library(knitr)
library(readr)
library(wordcloud)
library(wordcloud2)
library(RColorBrewer)
library(tm)
library(SnowballC)
library(XML)
library(RCurl)
library(ggpubr)
library(wesanderson)
library(reshape2)
library(MetBrewer)
library(sentimentr)
library(sna)
library(splitstackshape)
library(GGally)
library(ggraph)
library(gutenbergr)
library(igraph)
library(Matrix)
library(network)
library(tidygraph)
library(tibble)
library(formattable)
library(forcats)
library(lme4)
library(ggthemes)
library(lmerTest)
library(misty)
library(Rmisc)
library(effects)
library(arm)
library(sjPlot)
library(lattice)
library(devtools)
#devtools::install_github("strengejacke/sjPlot", force = TRUE)
library(sjPlot)
se <- function(x) sqrt(var(x)/length(x))  #function to calculate SE
```

### Load cleaned dataframe of sentiment + choice data

```{r message=FALSE, warning=FALSE}
# define color palette
# colors <- met.brewer("Hiroshige", 7, type = "discrete")
# palette <- met.brewer("Hiroshige", 25, type = "continuous")

## ----- LOAD CLEANED DATA ----- ##
#data.allChoices <- read.csv("NAs_survivor_data_cleaned.csv") #as a tibble
data <- read.csv("survivor_data_cleaned.csv")
head(data)
```

### Define model parameters

> Dependent variable = Percent_Time_Chosen  
Fixed effects = Block_Number  
Interaction effects = Sentiment * Block_Type  
Random effects = Block_Number  
Random effect grouped by Block_Type = PID  

3 types of sentiment scores - most recent, cumulative, & overall  
2 types of models per sentiment score type - target-choice & choice-target

***

### Overall sentiment ~ % time chosen

How well does overall sentiment between target + choice predict percent of time chosen?

#### First, I'll fit a linear mixed-effects model to my choice behavior + sentiment score data.

I run two models - one to compare target-choice sentiment to percent of time chosen and the other to compare choice-target sentiment to percent of time chosen. 

```{r message=FALSE, warning=FALSE}
## run the model
# How does overall sentiment predict percent of time chosen?
print("Target-Choice Model")
mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Overall * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
# get coefficient estimates and coefficient SEs; pull error terms from group and residual to calculate ICC based on model output (intercept SD/intercept SD + residual SD)
display(mlm2)

print("Choice-Target Model")
mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Overall * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(mlm3)
```

#### Now, I'll get a summary table of my model showing the estimates for my fixed effects, standard error, df, t values, and significance levels.

```{r message=FALSE, warning=FALSE}
# get fixed effects table with estimate, SE, df, t value, and significance
print("Target-Choice Model")
summary(mlm2)
print("Choice-Target Model")
summary(mlm3)
```

#### Now, I'll examine the coefficients in my model.

```{r message=FALSE, warning=FALSE}
## examine the coefficients
print("Target-Choice Model")
coef(mlm2)
fixef(mlm2)
ranef(mlm2)
se.fixef(mlm2)
se.ranef(mlm2)

print("Choice-Target Model")
coef(mlm3)
fixef(mlm3)
ranef(mlm3)
se.fixef(mlm3)
se.ranef(mlm3)
```

#### Now, I'm going to test my model against a null model.

```{r message=FALSE, warning=FALSE}
## test the model against the null model
# create the null model
print("Create null model for target-choice - comparing to a model without the block type interaction term")
null.mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Overall + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm2)

print("Create null model for choice-target - comparing to a model without the block type interaction term")
null.mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Overall + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm3)
```

#### Finally, I can compare my model to the null model by running an ANOVA.

```{r message=FALSE, warning=FALSE}
# test our model against the null model
print("Target-Choice Model")
anova(null.mlm2, mlm2)
print("Choice-Target Model")
anova(null.mlm3, mlm3)
```

### Plot!

```{r message=FALSE, warning=FALSE}
plot(effect("Target.Choice_Sentiment_Overall:Block_Type", mlm2), grid = T)

plot(effect("Choice.Target_Sentiment_Overall:Block_Type", mlm3), grid = T)

plot_model(mlm2, sort.est = TRUE)
plot_model(mlm3, sort.est = TRUE)
```

***

### Cumulative sentiment ~ % time chosen

How well does cumulative sentiment between target + choice predict percent of time chosen?

#### First, I'll fit a linear mixed-effects model to my choice behavior + sentiment score data.

```{r message=FALSE, warning=FALSE}
## run the model
# How does cumulative sentiment predict percent of time chosen?
print("Target-Choice Model")
mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Cumulative * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
# get coefficient estimates and coefficient SEs; pull error terms from group and residual to calculate ICC based on model output (intercept SD/intercept SD + residual SD)
display(mlm2)

print("Choice-Target Model")
mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Cumulative * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(mlm3)
```

#### Now, I'll get a summary table of my model showing the estimates for my fixed effects, standard error, df, t values, and significance levels.


```{r message=FALSE, warning=FALSE}
# get fixed effects table with estimate, SE, df, t value, and significance
print("Target-Choice Model")
summary(mlm2)
print("Choice-Target Model")
summary(mlm3)
```

#### Now, I'll examine the coefficients in my model.

```{r message=FALSE, warning=FALSE}
## examine the coefficients
print("Target-Choice Model")
coef(mlm2)
fixef(mlm2)
ranef(mlm2)
se.fixef(mlm2)
se.ranef(mlm2)

print("Choice-Target Model")
coef(mlm3)
fixef(mlm3)
ranef(mlm3)
se.fixef(mlm3)
se.ranef(mlm3)
```

#### Now, I'm going to test my model against a null model.

```{r message=FALSE, warning=FALSE}
## test the model against the null model
# create the null model
print("Create null model for target-choice - comparing to a model without the block type interaction term")
null.mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Cumulative + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm2)

print("Create null model for choice-target - comparing to a model without the block type interaction term")
null.mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Cumulative + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm3)
```

#### Finally, I can compare my model to the null model by running an ANOVA.

```{r message=FALSE, warning=FALSE}
# test our model against the null model
print("Target-Choice Model")
anova(null.mlm2, mlm2)
print("Choice-Target Model")
anova(null.mlm3, mlm3)
```

### Plot!

```{r message=FALSE, warning=FALSE}
plot(effect("Target.Choice_Sentiment_Cumulative:Block_Type", mlm2), grid = T)

plot(effect("Choice.Target_Sentiment_Cumulative:Block_Type", mlm3), grid = T)

plot_model(mlm2, sort.est = TRUE)
plot_model(mlm3, sort.est = TRUE)
```

***

### Most recent sentiment ~ % time chosen 

How well does most recent sentiment between target + choice predict percent of time chosen?

#### First, I'll fit a linear mixed-effects model to my choice behavior + sentiment score data.

```{r message=FALSE, warning=FALSE}
## run the model
# How does most recent sentiment predict percent of time chosen?
print("Target-Choice Model")
mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Recent * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
# get coefficient estimates and coefficient SEs; pull error terms from group and residual to calculate ICC based on model output (intercept SD/intercept SD + residual SD)
display(mlm2)

print("Choice-Target Model")
mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Recent * Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(mlm3)
```

#### Now, I'll get a summary table of my model showing the estimates for my fixed effects, standard error, df, t values, and significance levels.


```{r message=FALSE, warning=FALSE}
# get fixed effects table with estimate, SE, df, t value, and significance
print("Target-Choice Model")
summary(mlm2)
print("Choice-Target Model")
summary(mlm3)
```

#### Now, I'll examine the coefficients in my model.

```{r message=FALSE, warning=FALSE}
## examine the coefficients
print("Target-Choice Model")
coef(mlm2)
fixef(mlm2)
ranef(mlm2)
se.fixef(mlm2)
se.ranef(mlm2)

print("Choice-Target Model")
coef(mlm3)
fixef(mlm3)
ranef(mlm3)
se.fixef(mlm3)
se.ranef(mlm3)
```

#### Now, I'm going to test my model against a null model. 

```{r message=FALSE, warning=FALSE}
## test the model against the null model
# create the null model
print("Create null model for target-choice - comparing to a model without the block type interaction term")
null.mlm2 <- lmer(Percent_Time_Chosen ~ Target.Choice_Sentiment_Recent + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm2)

print("Create null model for choice-target - comparing to a model without the block type interaction term")
null.mlm3 <- lmer(Percent_Time_Chosen ~ Choice.Target_Sentiment_Recent + Block_Type + Block_Number + (Block_Type|PID) + (1|Block_Number), data = data)
display(null.mlm3)
```

#### Finally, I can compare my model to the null model by running an ANOVA.

```{r message=FALSE, warning=FALSE}
# test our model against the null model
print("Target-Choice Model")
anova(null.mlm2, mlm2)
print("Choice-Target Model")
anova(null.mlm3, mlm3)
```

### Plot!

```{r message=FALSE, warning=FALSE}
plot(effect("Target.Choice_Sentiment_Recent:Block_Type", mlm2), grid = T)

plot(effect("Choice.Target_Sentiment_Recent:Block_Type", mlm3), grid = T)

plot_model(mlm2, sort.est = TRUE)
plot_model(mlm3, sort.est = TRUE)
```

